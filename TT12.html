<script>
// ===== Hotfix: inicialización segura de Objetivos (sliders + botón Siguiente) =====
(function(){
  // listas y estados globales si aún no existen
  window.categoryList = window.categoryList || ['Atención','Credibilidad','Inspiración','Aplicabilidad','Apertura','Asombro'];
  window.goals = window.goals || (function(){ var o={}; for(var i=0;i<categoryList.length;i++){o[categoryList[i]]=0;} return o; })();

  function buildSliders(){
    var slidersEl = document.getElementById('sliders');
    if(!slidersEl) return;
    slidersEl.innerHTML = ''; // por si re-entramos
    for(var i=0;i<categoryList.length;i++){
      var cat = categoryList[i];
      var wrap = document.createElement('div');

      var label = document.createElement('label');
      label.id = 'lbl-' + cat;
      label.textContent = cat + ': ' + (window.goals[cat]||0) + '%';
      label.style.display = 'block';
      label.style.fontWeight = '700';
      label.style.marginBottom = '6px';

      var input = document.createElement('input');
      input.type = 'range'; input.min = 0; input.max = 100; input.step = 1;
      input.value = window.goals[cat] || 0;
      input.setAttribute('aria-label','Objetivo para ' + cat);
      input.oninput = (function(cat,label){
        return function(e){
          var v = parseInt(e.target.value,10)||0;
          window.goals[cat] = v;
          label.textContent = cat + ': ' + v + '%';
          updateTotalPercent();
          // salva borrador si existe función
          if(typeof window.saveDraft === 'function'){ window.saveDraft(); }
        };
      })(cat,label);

      wrap.appendChild(label);
      wrap.appendChild(input);
      slidersEl.appendChild(wrap);
    }
    updateTotalPercent();
  }

  function updateTotalPercent(){
    var total = 0;
    for(var i=0;i<categoryList.length;i++){ total += (window.goals[categoryList[i]]||0); }
    var el = document.getElementById('totalPercent');
    if(el){ el.textContent = total + '%'; }
  }

  // expón proceedToMain global para el onclick del botón
  window.proceedToMain = function(){
    var g = document.getElementById('goalSetting');
    var m = document.getElementById('mainContainer');
    if(g) g.style.display = 'none';
    if(m) m.style.display = 'flex';
    var hk = document.getElementById('hotkeysPanel'); if(hk) hk.style.display='block';
    // si existen, llama a constructores del resto de la app
    if(typeof window.buildRadial === 'function'){ window.buildRadial(); }
    if(typeof window.buildSummary === 'function'){ window.buildSummary(); }
    if(typeof window.restoreDraft === 'function'){ window.restoreDraft(); }
  };

  function initGoalsScreen(){
    buildSliders();
    // habilita “Siguiente” por si no tenía handler
    var btn = document.getElementById('btnProceed');
    if(btn && !btn.getAttribute('onclick')){
      btn.onclick = window.proceedToMain;
    }
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initGoalsScreen);
  } else {
    initGoalsScreen();
  }
})();
</script>
