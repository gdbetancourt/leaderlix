<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Evaluación de Presentaciones – Radar + Cuadrantes + Ruido</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --res:#1c1e2c;   /* Resultados */
      --obj:#00FFFF;   /* Objetivos */
      --ok:#18a957;
      --warn:#f0ad4e;
      --border:#1c1e2c;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#222}
    header{padding:16px 24px;background:#fff;border-bottom:1px solid #e9e9e9;position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:20px}

    .container{display:none;flex-direction:column;align-items:center;gap:20px;padding:20px}

    #timer{font-variant-numeric:tabular-nums;font-size:44px;font-weight:800;text-align:right;width:100%;max-width:960px}
    .controls{display:grid;grid-template-columns:1fr auto auto auto auto;gap:10px;width:100%;max-width:960px}
    .controls input{padding:10px;font-size:16px;border:1px solid #ccc;border-radius:8px}
    .controls button{padding:10px 14px;font-size:16px;border:none;border-radius:8px;color:#fff;cursor:pointer}
    #startStopButton,#pauseResumeButton,#resetButton,#exportButton{background:var(--res)}
    .controls button[disabled]{opacity:.45;cursor:default}

    .workspace{display:grid;grid-template-columns:auto 84px;gap:16px;align-items:start}
    @media (max-width:840px){ .workspace{grid-template-columns:1fr} }

    .radial-board{position:relative;width:min(520px,90vw);height:min(520px,90vw)}
    .circle-btn{position:absolute;width:84px;height:84px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;border:none;color:#fff;cursor:pointer;transform:translate(-50%,-50%);transition:transform .08s ease, box-shadow .08s ease;background:var(--res)}
    .circle-btn:active{transform:translate(-50%,-50%) scale(.98)}
    .active-ring{box-shadow:0 0 0 8px rgba(28,30,44,.18)}
    .label{position:absolute;transform:translate(-50%,-50%);font-size:16px;color:#444;font-weight:700;pointer-events:none}
    .noise-btn{background:#9b9b9b}

    /* mini-panel eje vertical */
    .axis-panel{display:flex;flex-direction:column;gap:12px}
    .axis-btn{width:84px;min-height:84px;border-radius:14px;border:2px solid #ddd;background:#fff;color:#222;font-weight:800;font-size:14px;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.08);transition:box-shadow .1s ease, transform .05s ease}
    .axis-btn:active{transform:scale(.98)}
    .axis-btn.active{outline:0;box-shadow:0 0 0 6px rgba(28,30,44,.18), 0 1px 4px rgba(0,0,0,.08);border-color:var(--border)}
    .axis-btn span{display:block}
    .axis-up::before{content:"↑";display:block;font-size:18px;margin-bottom:4px}
    .axis-down::before{content:"↓";display:block;font-size:18px;margin-bottom:4px}

    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;max-width:960px;width:100%}
    @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}

    .summary-item{background:#fff;border:1px solid #e1e1e1;border-radius:10px;padding:10px;font-size:15px;line-height:1.35;display:flex;flex-direction:column;gap:6px}
    .summary-item .row{display:flex;justify-content:space-between;gap:10px}
    .summary-item .time{font-weight:800;font-variant-numeric:tabular-nums}
    .summary-item .pct{color:#777}

    .totals{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;max-width:960px;width:100%}
    @media (max-width:900px){.totals{grid-template-columns:1fr 1fr}}
    .total-chip{background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:10px}
    .total-chip h4{margin:0 0 6px 0}
    .total-chip .k{font-variant-numeric:tabular-nums;font-weight:800}

    .panel{width:min(960px,94vw);background:#fff;border:1px solid #e5e5e5;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06);padding:16px}
    .panel h3{margin:6px 0 12px 0}

    .charts-wrap{display:grid;grid-template-columns:1fr 1fr;gap:16px;width:min(960px,94vw)}
    @media (max-width:900px){.charts-wrap{grid-template-columns:1fr}}
    .chart-box{width:100%;border:2px solid #222;padding:16px;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    canvas{width:100%!important;height:100%!important}

    /* Ruido vs Señal bar */
    .noise-wrap{width:min(960px,94vw);background:#fff;border:1px solid #e5e5e5;border-radius:12px;padding:14px}
    .noise-bar{height:16px;border-radius:10px;background:#eee;overflow:hidden}
    .noise-fill{height:100%;background:#9b9b9b}
    .noise-legend{display:flex;justify-content:space-between;font-size:13px;margin-top:6px}

    /* Pantalla de objetivos */
    #goalSetting{max-width:960px;margin:24px auto;padding:32px;background:#fff;border-radius:24px;box-shadow:0 2px 6px rgba(0,0,0,.08);border:1px solid #ececec}
    #goalSetting h2{text-align:center;margin:0 0 18px 0;font-size:44px}
    #goalSetting p{text-align:center;font-size:28px;line-height:1.3;margin:0 0 18px 0}
    #goalSetting .sliders{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
    #goalSetting .sliders>div{background:#fafafa;border:1px solid #eee;border-radius:10px;padding:10px}
    #goalSetting button{display:block;margin:20px auto 0 auto;padding:12px 24px;background:var(--res);color:#fff;border:none;border-radius:14px;font-size:28px}
    .mini{font-size:22px;color:#666;margin-top:-6px;text-align:center}
    input[type="range"]{width:100%}
  </style>
</head>
<body>
<header>
  <h1 aria-live="polite">Evaluación de Presentaciones – Radar + Cuadrantes + Ruido</h1>
</header>

<!-- Pantalla 1: objetivos con sliders -->
<div id="goalSetting" aria-labelledby="titleGoals">
  <h2 id="titleGoals">Define tus Objetivos (Opcional)</h2>
  <p>Ajusta el porcentaje para cada categoría. No es necesario llegar a 100%.</p>
  <div id="sliders" class="sliders" role="group" aria-label="Sliders de objetivos"></div>
  <p style="font-weight:bold;text-align:center;font-size:36px">Total asignado: <span id="totalPercent">0%</span></p>
  <p class="mini">Tip: 1–6 categorías, P/D eje vertical, R = Ruido (centro), todo tras iniciar el cronómetro.</p>
  <button id="btnProceed">Siguiente</button>
</div>

<!-- Pantalla 2: cronómetro y resultados -->
<div class="container" id="mainContainer">
  <div id="timer" aria-live="polite">00:00:00</div>
  <div class="controls">
    <input id="personName" type="text" placeholder="Nombre" aria-label="Nombre de la persona"/>
    <button id="startStopButton" disabled title="Iniciar o detener">Comenzar</button>
    <button id="pauseResumeButton" disabled title="Pausar o reanudar">Pausa</button>
    <button id="resetButton" disabled title="Reiniciar todo">Reiniciar</button>
    <button id="exportButton" disabled title="Exportar resultados">Exportar</button>
  </div>

  <div class="panel" id="hotkeysPanel" style="display:none">
    <h3>Atajos de teclado</h3>
    <div class="badges" id="hotkeysBadges"></div>
  </div>

  <!-- Tablero + eje vertical -->
  <div class="workspace">
    <div class="radial-board" aria-label="Tablero radial" role="group"></div>
    <div class="axis-panel" aria-label="Eje vertical Persuasión/Disponibilización" role="group">
      <button id="btnPersu" class="axis-btn axis-up" aria-pressed="false" title="Activar Persuasión (P)"><span>Persuasión</span></button>
      <button id="btnDispo" class="axis-btn axis-down" aria-pressed="false" title="Activar Disponibilización (D)"><span>Disponibilización</span></button>
    </div>
  </div>

  <div class="grid" id="summaryGrid" aria-live="polite"></div>

  <!-- Ruido vs Señal -->
  <div class="noise-wrap" aria-live="polite">
    <h3 style="margin:0 0 8px 0">Ruido vs Señal</h3>
    <div class="noise-bar"><div id="noiseFill" class="noise-fill" style="width:0%"></div></div>
    <div class="noise-legend">
      <span>Ruido: <strong id="noisePct">0%</strong> (<span id="noiseTime">00:00:00</span>)</span>
      <span>Señal: <strong id="signalPct">100%</strong> (<span id="signalTime">00:00:00</span>)</span>
    </div>
  </div>

  <div class="totals" id="totalsGrid" aria-live="polite">
    <div class="total-chip"><h4>Empatía</h4><div class="k"><span id="empatiaTime">00:00:00</span> • <span id="empatiaPct">0%</span></div></div>
    <div class="total-chip"><h4>Asertividad</h4><div class="k"><span id="asertTime">00:00:00</span> • <span id="asertPct">0%</span></div></div>
    <div class="total-chip"><h4>Persuasión</h4><div class="k"><span id="persuTime">00:00:00</span> • <span id="persuPct">0%</span></div></div>
    <div class="total-chip"><h4>Disponibilización</h4><div class="k"><span id="dispoTime">00:00:00</span> • <span id="dispoPct">0%</span></div></div>
  </div>

  <div class="charts-wrap">
    <div class="chart-box"><canvas id="radarChart"></canvas></div>
    <div class="chart-box"><canvas id="quadrantChart"></canvas></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
// ====== Categorías ======
const categoryList=['Atención','Credibilidad','Inspiración','Aplicabilidad','Apertura','Asombro'];
const tiempos=Object.fromEntries(categoryList.map(c=>[c,0]));
const goals=Object.fromEntries(categoryList.map(c=>[c,0]));

// ====== Eje vertical ======
const axis={persu:0, dispo:0};
let lastAxis=null; // 'persu' | 'dispo' | null
let lastAxisStamp=0;

// ====== Ruido ======
let noise_ms=0;
let lastMode='none'; // 'cat' | 'noise' | 'none'
let lastCat=null;

// ====== Estado ======
let running=false, paused=false, startTime=0, pauseStart=0, totalElapsed=0, lastStamp=0, timerInterval, statsInterval, radarInstance, quadInstance;

// ====== UI refs ======
const slidersEl=document.getElementById('sliders');
const totalPercentEl=document.getElementById('totalPercent');
const nameInput=document.getElementById('personName');
const startBtn=document.getElementById('startStopButton');
const pauseBtn=document.getElementById('pauseResumeButton');
const resetBtn=document.getElementById('resetButton');
const exportBtn=document.getElementById('exportButton');
const btnPersu=document.getElementById('btnPersu');
const btnDispo=document.getElementById('btnDispo');
const btnProceed=document.getElementById('btnProceed');

// Sliders (FIX: construir después de que el DOM está listo)
categoryList.forEach(cat=>{
  const wrap=document.createElement('div');
  const label=document.createElement('label');
  label.id=`lbl-${cat}`;label.textContent=`${cat}: 0%`;
  label.style.display='block'; label.style.fontWeight='700'; label.style.marginBottom='6px';
  const input=document.createElement('input');
  input.type='range'; input.min=0; input.max=100; input.value=0; input.step=1; input.setAttribute('aria-label',`Objetivo para ${cat}`);
  input.oninput=e=>{goals[cat]=+e.target.value; label.textContent=`${cat}: ${goals[cat]}%`; updateTotalPercent(); saveDraft();};
  wrap.append(label,input);
  slidersEl.appendChild(wrap);
});
function updateTotalPercent(){ totalPercentEl.textContent=`${Object.values(goals).reduce((a,b)=>a+b,0)}%`; }

// Hotkeys panel
const hkPanel=document.getElementById('hotkeysPanel');
const hkBadges=document.getElementById('hotkeysBadges');
categoryList.forEach((cat,i)=>{ const k=i+1; const b=document.createElement('span'); b.className='badge'; b.textContent=`${k} = ${cat}`; hkBadges.appendChild(b); });
['P = Persuasión','D = Disponibilización','R = Ruido'].forEach(t=>{ const b=document.createElement('span'); b.className='badge'; b.textContent=t; hkBadges.appendChild(b); });

// Navegar a pantalla principal (FIX: eventListener en lugar de inline)
btnProceed.addEventListener('click', proceedToMain);
function proceedToMain(){
  document.getElementById('goalSetting').style.display='none';
  document.getElementById('mainContainer').style.display='flex';
  hkPanel.style.display='block';
  buildRadial();
  buildSummary();
  restoreDraft(); // restaura y hace primer update
}

nameInput.addEventListener('input',()=>{ startBtn.disabled=nameInput.value.trim()===''; });

// ====== Radial (incluye RUÍDO centro) ======
function buildRadial(){
  const board=document.querySelector('.radial-board');
  board.innerHTML='';
  const size=board.clientWidth; const cx=size/2; const cy=size/2;
  const angles=[270,330,30,90,150,210];
  const rBtn=Math.min(160,size*0.31); const rLbl=Math.min(220,size*0.42);

  // Botones de categorías
  categoryList.forEach((cat,i)=>{
    const a=angles[i]*(Math.PI/180);
    const xB=cx+rBtn*Math.cos(a), yB=cy+rBtn*Math.sin(a);
    const btn=document.createElement('button');
    btn.className='circle-btn'; btn.style.left=`${xB}px`; btn.style.top=`${yB}px`; btn.textContent=cat.split(' ')[0];
    btn.addEventListener('click',()=> pressCategory(cat,btn));
    btn.title=`Activar ${cat}`;
    btn.setAttribute('aria-pressed','false');
    btn.setAttribute('role','button');
    board.appendChild(btn);

    const xL=cx+rLbl*Math.cos(a), yL=cy+rLbl*Math.sin(a);
    const label=document.createElement('span');
    label.className='label'; label.style.left=`${xL}px`; label.style.top=`${yL}px`; label.textContent=cat;
    board.appendChild(label);
  });

  // Botón RUÍDO (centro)
  const noiseBtn=document.createElement('button');
  noiseBtn.className='circle-btn noise-btn'; noiseBtn.style.left=`${cx}px`; noiseBtn.style.top=`${cy}px`; noiseBtn.textContent='Ruido';
  noiseBtn.title='Activar Ruido (R)';
  noiseBtn.setAttribute('aria-pressed','false');
  noiseBtn.setAttribute('role','button');
  noiseBtn.addEventListener('click',()=> pressNoise(noiseBtn));
  board.appendChild(noiseBtn);
}

// ====== Resumen por categoría ======
function buildSummary(){
  const grid=document.getElementById('summaryGrid');
  grid.innerHTML='';
  categoryList.forEach(cat=>{
    const div=document.createElement('div');
    div.className='summary-item';
    div.innerHTML=`<div class="row"><strong>${cat}</strong><span class="badges" id="badge-${cat}"></span></div>
      <div class="row">Tiempo <span id="${cat}-time" class="time">00:00:00</span>
      <span class="pct" id="${cat}-pct">(0%)</span></div>`;
    grid.appendChild(div);
  });
}

// ====== Cronómetro ======
const pad=n=>n<10?`0${n}`:n;
const fmt=ms=>{ms=Math.max(0,Math.floor(ms));const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return `${pad(h)}:${pad(m)}:${pad(sec)}`};

document.getElementById('startStopButton').addEventListener('click', startStopTimer);
document.getElementById('pauseResumeButton').addEventListener('click', pauseResumeTimer);
document.getElementById('resetButton').addEventListener('click', hardReset);
document.getElementById('exportButton').addEventListener('click', exportSession);

function startStopTimer(){
  if(!running){
    softReset();
    startTime=performance.now();
    lastStamp=startTime;
    running=true; paused=false;
    timerInterval=setInterval(()=>updateTimer(),1000);
    statsInterval=setInterval(updateStats,1000);
    startBtn.textContent='Detener';
    pauseBtn.disabled=false; resetBtn.disabled=false; exportBtn.disabled=false; nameInput.disabled=true;
    window.addEventListener('keydown',onKey);
  }else{
    settleSegment();
    settleAxis();
    clearInterval(timerInterval); clearInterval(statsInterval);
    running=false;
    startBtn.textContent='Comenzar';
    pauseBtn.disabled=true; nameInput.disabled=false;
    drawRadar();
    drawQuadrant();
    window.removeEventListener('keydown',onKey);
  }
}

function pauseResumeTimer(){
  if(!running) return;
  if(!paused){
    settleSegment();
    settleAxis();
    clearInterval(timerInterval); clearInterval(statsInterval);
    pauseStart=performance.now(); paused=true; pauseBtn.textContent='Reanudar';
  }else{
    const delta=performance.now()-pauseStart;
    startTime+=delta; lastStamp+=delta; if(lastAxisStamp) lastAxisStamp+=delta;
    paused=false; pauseBtn.textContent='Pausa';
    timerInterval=setInterval(()=>updateTimer(),1000);
    statsInterval=setInterval(updateStats,1000);
  }
}

function updateTimer(){
  const now=performance.now();
  totalElapsed=now-startTime;
  document.getElementById('timer').textContent=fmt(totalElapsed);
}

// ====== Asentado de tramos ======
function settleSegment(){
  const now=performance.now();
  const elapsed=now-lastStamp;
  if(elapsed>0){
    if(lastMode==='cat' && lastCat){
      tiempos[lastCat]+=elapsed;
    }else if(lastMode==='noise'){
      noise_ms+=elapsed;
    }
  }
  lastStamp=now;
}

function settleAxis(){
  if(!lastAxis) return;
  const now=performance.now();
  const elapsed=now-lastAxisStamp;
  if(elapsed>0) axis[lastAxis]+=elapsed;
  lastAxisStamp=now;
}

// ====== Activaciones ======
function pressCategory(cat,el){
  if(!running||paused) return;
  settleSegment();
  lastMode='cat'; lastCat=cat; lastStamp=performance.now();
  flash(el);
  updateStats();
}
function pressNoise(el){
  if(!running||paused) return;
  settleSegment();
  lastMode='noise'; lastCat=null; lastStamp=performance.now();
  flash(el);
  updateStats();
}

function flash(el){
  clearActiveRings();
  el.classList.add('active-ring');
  // set aria-pressed
  document.querySelectorAll('.radial-board .circle-btn').forEach(b=>{
    b.setAttribute('aria-pressed', b===el ? 'true' : 'false');
  });
}
function clearActiveRings(){
  document.querySelectorAll('.circle-btn').forEach(b=>b.classList.remove('active-ring'));
}

// ====== Botones eje vertical ======
function setAxisActive(which){ // 'persu' | 'dispo' | null
  btnPersu.classList.toggle('active', which==='persu');
  btnDispo.classList.toggle('active', which==='dispo');
  btnPersu.setAttribute('aria-pressed', which==='persu'?'true':'false');
  btnDispo.setAttribute('aria-pressed', which==='dispo'?'true':'false');
  lastAxis=which;
  lastAxisStamp = which ? performance.now() : 0;
}
btnPersu.onclick=()=>{ if(!running||paused) return; settleAxis(); setAxisActive('persu'); updateStats(); };
btnDispo.onclick=()=>{ if(!running||paused) return; settleAxis(); setAxisActive('dispo'); updateStats(); };

// ====== Stats + Totales + Ruido ======
function updateStats(){
  const t=Math.max(1,totalElapsed); // evita NaN/Inf
  categoryList.forEach(c=>{
    const v=tiempos[c];
    const pct=(v/t*100)||0;
    const elT=document.getElementById(`${c}-time`);
    const elP=document.getElementById(`${c}-pct`);
    if(elT) elT.textContent=fmt(v);
    if(elP) elP.textContent=`(${pct.toFixed(1)}%)`;

    const target=goals[c];
    const cont=document.getElementById(`badge-${c}`);
    if(cont){
      cont.innerHTML='';
      if(target>0){
        const diff=pct-target;
        const b=document.createElement('span'); b.className='badge ' + (Math.abs(diff)<=7? 'ok':'warn');
        b.textContent=`${diff>=0?'+':''}${diff.toFixed(1)} pts vs obj.`;
        cont.appendChild(b);
      }
    }
  });

  const empatia_ms = (tiempos['Atención']||0) + (tiempos['Apertura']||0) + (tiempos['Inspiración']||0);
  const asertividad_ms = (tiempos['Asombro']||0) + (tiempos['Credibilidad']||0) + (tiempos['Aplicabilidad']||0);
  const sumCat = empatia_ms + asertividad_ms || 1;

  const totalAxis = (axis.persu||0)+(axis.dispo||0) || 1;

  document.getElementById('empatiaTime').textContent=fmt(empatia_ms);
  document.getElementById('empatiaPct').textContent=((empatia_ms/sumCat*100)||0).toFixed(1)+'%';
  document.getElementById('asertTime').textContent=fmt(asertividad_ms);
  document.getElementById('asertPct').textContent=((asertividad_ms/sumCat*100)||0).toFixed(1)+'%';

  document.getElementById('persuTime').textContent=fmt(axis.persu);
  document.getElementById('persuPct').textContent=((axis.persu/totalAxis*100)||0).toFixed(1)+'%';
  document.getElementById('dispoTime').textContent=fmt(axis.dispo);
  document.getElementById('dispoPct').textContent=((axis.dispo/totalAxis*100)||0).toFixed(1)+'%';

  // Ruido vs Señal
  const signal_ms = empatia_ms + asertividad_ms;
  const denomRS = (noise_ms + signal_ms) || 1;
  const noisePct = (noise_ms/denomRS*100)||0;
  const signalPct = 100 - noisePct;
  document.getElementById('noiseFill').style.width = noisePct.toFixed(1)+'%';
  document.getElementById('noisePct').textContent = noisePct.toFixed(1)+'%';
  document.getElementById('signalPct').textContent = signalPct.toFixed(1)+'%';
  document.getElementById('noiseTime').textContent = fmt(noise_ms);
  document.getElementById('signalTime').textContent = fmt(signal_ms);

  drawQuadrant(); // vivo
  saveDraft();
}

// ====== Radar ======
function drawRadar(){
  const ctx=document.getElementById('radarChart').getContext('2d');
  const resRaw=categoryList.map(c=>tiempos[c]);
  const objRaw=categoryList.map(c=>goals[c]);
  const nrm=(arr)=>{ const mx=Math.max(1,...arr); return arr.map(v=>+(v/mx*100).toFixed(2)); };
  const resData=nrm(resRaw), objData=nrm(objRaw);
  if(radarInstance) radarInstance.destroy();
  radarInstance=new Chart(ctx,{
    type:'radar',
    data:{labels:categoryList,datasets:[
      {label:'Objetivos',data:objData,backgroundColor:'rgba(0,255,255,0.25)',borderColor:'#00FFFF',borderWidth:2,tension:.25},
      {label:'Resultados',data:resData,backgroundColor:'rgba(28,30,44,0.25)',borderColor:getComputedStyle(document.documentElement).getPropertyValue('--res').trim()||'#1c1e2c',borderWidth:2,tension:.25}
    ]},
    options:{responsive:true,maintainAspectRatio:true,scales:{ r:{ beginAtZero:true, max:100, ticks:{display:false}, grid:{color:'#ddd'}, pointLabels:{ font:{size:13}, color:'#333' } } },plugins:{ legend:{ position:'top' } }}
  });
}

// ====== Cuadrantes ======
function drawQuadrant(){
  const canvas=document.getElementById('quadrantChart');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');

  const empatia_ms = (tiempos['Atención']||0) + (tiempos['Apertura']||0) + (tiempos['Inspiración']||0);
  const asertividad_ms = (tiempos['Asombro']||0) + (tiempos['Credibilidad']||0) + (tiempos['Aplicabilidad']||0);
  const denomX = empatia_ms + asertividad_ms;
  const x = denomX ? +(100*asertividad_ms/denomX).toFixed(2) : 50;

  const denomY = (axis.persu||0) + (axis.dispo||0);
  const y = denomY ? +(100*axis.persu/denomY).toFixed(2) : 50;

  const point = {x,y};

  const quadBgPlugin = {
    id:'quadBg',
    beforeDraw(chart){
      const {ctx, chartArea:{left,right,top,bottom,width,height}} = chart;
      const cx = left + width/2;
      const cy = top + height/2;
      ctx.save();
      ctx.fillStyle='rgba(255,61,46,0.06)'; ctx.fillRect(left, top, width/2, height/2);
      ctx.fillStyle='rgba(28,30,44,0.06)'; ctx.fillRect(cx, top, width/2, height/2);
      ctx.fillStyle='rgba(46,233,255,0.08)'; ctx.fillRect(left, cy, width/2, height/2);
      ctx.fillStyle='rgba(255,61,46,0.06)'; ctx.fillRect(cx, cy, width/2, height/2);
      ctx.strokeStyle='#999'; ctx.lineWidth=1; ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(cx, top); ctx.lineTo(cx, bottom); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(left, cy); ctx.lineTo(right, cy); ctx.stroke(); ctx.setLineDash([]);
      ctx.fillStyle='#222'; ctx.font='600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText('Inspirational', left + width*0.25, top + height*0.25);
      ctx.fillText('Commercial',   left + width*0.75, top + height*0.25);
      ctx.fillText('Educational',  left + width*0.25, top + height*0.75);
      ctx.fillText('Executive',    left + width*0.75, top + height*0.75);
      ctx.font='600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.save(); ctx.translate(left-8, cy); ctx.rotate(-Math.PI/2); ctx.textAlign='center'; ctx.fillText('Empatía', 0, 0); ctx.restore();
      ctx.save(); ctx.translate(right+8, cy); ctx.rotate(Math.PI/2); ctx.textAlign='center'; ctx.fillText('Asertividad', 0, 0); ctx.restore();
      ctx.textAlign='center'; ctx.fillText('Persuasión', (left+right)/2, top-12); ctx.fillText('Disponibilización', (left+right)/2, bottom+12);
      ctx.restore();
    }
  };

  if(quadInstance) quadInstance.destroy();
  quadInstance = new Chart(ctx, {
    type:'scatter',
    data:{ datasets:[{ label:'Sesión', data:[point], pointRadius:6, pointHoverRadius:7, borderWidth:2, borderColor:getComputedStyle(document.documentElement).getPropertyValue('--border').trim()||'#1c1e2c', backgroundColor:'rgba(28,30,44,0.8)', showLine:false }]},
    options:{responsive:true,maintainAspectRatio:true,animation:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:(c)=>`x: ${c.parsed.x.toFixed(1)}%, y: ${c.parsed.y.toFixed(1)}%`}}},layout:{padding:{top:24,bottom:24,left:24,right:24}},scales:{x:{min:0,max:100,grid:{display:false},ticks:{display:false},title:{display:true,text:'Empatía ⇢ Asertividad'}},y:{min:0,max:100,grid:{display:false},ticks:{display:false},title:{display:true,text:'Disponibilización ⇣ / Persuasión ⇡'}}},
    plugins:[quadBgPlugin]
  });
}

// ====== Exportación ======
function exportSession(){
  if(running && !paused){ settleSegment(); settleAxis(); }
  const name=nameInput.value.trim()||'SinNombre';
  const empatia_ms = (tiempos['Atención']||0) + (tiempos['Apertura']||0) + (tiempos['Inspiración']||0);
  const asertividad_ms = (tiempos['Asombro']||0) + (tiempos['Credibilidad']||0) + (tiempos['Aplicabilidad']||0);
  const denomX = empatia_ms + asertividad_ms;
  const x = denomX ? +(100*asertividad_ms/denomX).toFixed(2) : 50;
  const denomY = (axis.persu||0) + (axis.dispo||0);
  const y = denomY ? +(100*axis.persu/denomY).toFixed(2) : 50;
  const signal_ms = empatia_ms + asertividad_ms;
  const noise_pct = (noise_ms/Math.max(1, (noise_ms+signal_ms))) * 100;

  const porcentajes=Object.fromEntries(categoryList.map(c=>[c, totalElapsed? +(tiempos[c]/totalElapsed*100).toFixed(2):0 ]));
  const summary={
    nombre:name,
    fecha:new Date().toISOString(),
    total_ms:Math.round(totalElapsed),
    objetivos:{...goals},
    tiempos_ms:{...tiempos},
    porcentajes,
    empatia_ms: Math.round(empatia_ms),
    asertividad_ms: Math.round(asertividad_ms),
    persuasion_ms: Math.round(axis.persu||0),
    disponibilizacion_ms: Math.round(axis.dispo||0),
    noise_ms: Math.round(noise_ms),
    signal_ms: Math.round(signal_ms),
    noise_pct: +noise_pct.toFixed(2),
    coords_cuadrante: { x, y }
  };

  const blob=new Blob([JSON.stringify(summary,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`Radar_${name}_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
  if(radarInstance){ const l=document.createElement('a'); l.download=`Radar_${name}_radar.png`; l.href=radarInstance.toBase64Image(); l.click(); }
  if(quadInstance){ const l2=document.createElement('a'); l2.download=`Radar_${name}_cuadrantes.png`; l2.href=quadInstance.toBase64Image(); l2.click(); }
}

// ====== Persistencia ======
function saveDraft(){
  const draft={goals,tiempos,name: nameInput.value, axis:{...axis}, lastAxis, noise_ms, lastMode, lastCat};
  localStorage.setItem('radar-categorias-draft', JSON.stringify(draft));
}
function restoreDraft(){
  try{
    const raw=localStorage.getItem('radar-categorias-draft'); if(!raw){ updateStats(); return; }
    const d=JSON.parse(raw);
    if(d.name){ nameInput.value=d.name; startBtn.disabled=nameInput.value.trim()===''; }
    if(d.goals){ Object.assign(goals,d.goals); categoryList.forEach(cat=>{ const v=goals[cat]||0; const lbl=document.getElementById(`lbl-${cat}`); const rng=lbl?.nextElementSibling; if(rng){ rng.value=v; lbl.textContent=`${cat}: ${v}%`; } }); updateTotalPercent(); }
    if(d.tiempos) Object.assign(tiempos,d.tiempos);
    if(d.axis){ axis.persu=d.axis.persu||0; axis.dispo=d.axis.dispo||0; }
    if(typeof d.noise_ms==='number') noise_ms=d.noise_ms;
    lastMode='none'; lastCat=null; // no reactivar nada al cargar
    updateStats();
  }catch(e){ console.warn('No se pudo restaurar borrador',e); updateStats(); }
}

// ====== Atajos ======
function onKey(e){
  if(!running||paused) return;
  const n=parseInt(e.key,10);
  if(n>=1 && n<=6){ const cat=categoryList[n-1]; const btn=findButton(cat); pressCategory(cat, btn); return; }
  if(e.key==='p' || e.key==='P'){ settleAxis(); setAxisActive('persu'); updateStats(); return; }
  if(e.key==='d' || e.key==='D'){ settleAxis(); setAxisActive('dispo'); updateStats(); return; }
  if(e.key==='r' || e.key==='R'){ const btn=findNoiseBtn(); pressNoise(btn); return; }
}
function findButton(cat){
  const board=document.querySelector('.radial-board');
  const btns=[...board.querySelectorAll('.circle-btn')];
  return btns.find(b=> b.title?.includes(cat));
}
function findNoiseBtn(){
  return document.querySelector('.radial-board .noise-btn');
}

// Prevenir pérdida accidental
window.addEventListener('beforeunload', (e)=>{ if(running){ e.preventDefault(); e.returnValue=''; } });

// Habilitar Start al escribir nombre
nameInput.addEventListener('input',()=>{ startBtn.disabled = nameInput.value.trim()===''; });

}); // DOMContentLoaded
</script>
</body>
</html>
