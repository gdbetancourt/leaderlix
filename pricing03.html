<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Opciones de Inscripción — Vista Corporativa</title>
<link href="https://fonts.googleapis.com/css2?family=Gochi+Hand&display=swap" rel="stylesheet">
<style>
  :root{ --gap:16px; --radius:16px; --bg:#ffffff; --card:#ffffff; --bord:#e5e7eb; --muted:#49566a; --accent:#ff3300; --text:#111111; --ok:#16a34a; --warn:#c2410c; --shadow:0 6px 24px rgba(0,0,0,.06);}
  *{box-sizing:border-box} body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:28px 20px 64px}
  h1{margin:0 0 8px;font-size:36px;text-align:center;font-family:"Gochi Hand",Arial,Helvetica,sans-serif;color:var(--accent)}
  .muted{color:var(--muted);text-align:center;margin-bottom:18px}
  .grid{display:grid;gap:var(--gap)} .row3{grid-template-columns:repeat(3,1fr)} @media (max-width:980px){.row3{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--bord);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
  .pricing{display:flex;flex-direction:column;gap:14px}
  .title{font-weight:800;font-size:26px;text-align:center;margin-bottom:6px;font-family:"Gochi Hand",Arial,Helvetica,sans-serif;color:var(--accent)}
  .label{color:#334155;font-size:14px} .subtle{color:#64748b;font-size:13px}
  .line{display:flex;justify-content:space-between;align-items:center;gap:12px;padding-top:6px}
  select,input[type="text"],input[type="number"],input[type="email"],input[type="tel"],textarea{width:100%;background:#fff;color:#111;border:1px solid #c9d1db;border-radius:12px;padding:10px 12px;font-size:15px}
  textarea{min-height:88px;resize:vertical} button{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:700}
  .hint{color:#64748b;font-size:12px} .hidden{display:none}
  ul.benefits{list-style:none;margin:6px 0 0;padding:0;display:flex;flex-direction:column;gap:6px}
  ul.benefits li{display:flex;gap:8px;align-items:flex-start;font-size:15px}
  .check{font-weight:700} .off{color:#94a3b8} .off s{color:inherit}
  .grand{font-weight:800;font-size:22px;color:var(--accent)}
  #top-controls{display:flex;gap:24px;justify-content:center;align-items:center;margin:8px 0 22px}
  .toggle{position:relative;width:160px;height:40px;background:#fff;border:1px solid #c9d1db;border-radius:999px;cursor:pointer}
  .toggle::after{content:"";position:absolute;top:4px;left:4px;width:32px;height:32px;background:var(--accent);border-radius:50%;transition:left .18s ease}
  .toggle.right::after{left:124px}
  .coupon-row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-top:10px}
  .sum-grid{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:10px}
  #errorBox{display:none;margin:10px auto 0;max-width:780px;background:#fff0f0;color:#7f1d1d;border:1px solid #fecaca;padding:10px 12px;border-radius:8px}
  .pill{display:inline-block;border:1px solid #cbd5e1;border-radius:999px;padding:2px 8px;font-size:12px;color:#64748b;margin-left:6px}
</style>
</head>
<body>
<div class="container">
  <h1>Opciones de Inscripción</h1>
  <div class="muted">Vista corporativa</div>
  <div id="corp-hint" class="muted">Selecciona suficientes participantes en alguna membresía para activar el proyecto corporativo.</div>

  <div id="top-controls" aria-label="Preferencias">
    <div style="text-align:center">
      <div style="font-size:12px;color:#64748b;margin-bottom:6px">Moneda</div>
      <div id="currencyToggle" class="toggle" role="switch" aria-checked="false" title="Cambiar entre MXN y USD"></div>
      <div style="display:flex;justify-content:space-between;font-size:13px;color:#64748b;margin-top:6px"><span>🇲🇽 MXN</span><span>USD 🇺🇸</span></div>
    </div>
  </div>

  <div id="errorBox" role="alert"></div>

  <!-- Generales del proyecto -->
  <div id="gp-card" class="card hidden">
    <h3 style="margin:0 0 8px;font-size:22px;color:#111">Generales del Proyecto</h3>
    <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
      <div><label class="label">Fecha de la propuesta</label><input id="gp-fecha" type="text" readonly></div>
      <div><label class="label">Vigencia de la propuesta</label><input id="gp-vigencia" type="text" readonly></div>
      <div><label class="label">Nombre de la empresa</label><input id="gp-empresa" type="text" placeholder="Ej. ACME S.A. de C.V."></div>
      <div><label class="label">Nombre de quien solicita</label><input id="gp-solicita" type="text" placeholder="Ej. Ana Pérez"></div>
      <div><label class="label">Responsable en Leaderlix</label><input id="gp-resp" type="text" placeholder="Ej. Gerardo Betancourt"></div>
      <div><label class="label">Teléfono</label><input id="gp-tel" type="tel" placeholder="Ej. +52 55 1234 5678"></div>
      <div><label class="label">Correo</label><input id="gp-mail" type="email" placeholder="Ej. contacto@empresa.com"></div>
      <div class="full" style="grid-column:1/-1"><label class="label">Generales del proyecto</label><textarea id="gp-notas" placeholder="Describe brevemente el contexto, objetivos, sede(s), fechas tentativas y consideraciones."></textarea></div>
    </div>
  </div>

  <!-- Pricing cards -->
  <div id="cards" class="grid row3" aria-live="polite"></div>

  <!-- Detalle de beneficios (texto) para corporativo -->
  <div id="corp-benefits-detail" class="grid hidden" style="grid-template-columns:1fr;gap:12px;margin-top:12px"></div>

  <!-- Activables a nivel proyecto -->
  <div id="activables-card" class="card hidden">
    <h3 style="margin:0 0 8px;font-size:20px;color:#111">Beneficios que requieren activación</h3>
    <div id="activables-body" class="grid" style="grid-template-columns:1fr;gap:8px"></div>
  </div>

  <!-- Totales -->
  <div id="totales" class="card hidden">
    <div class="coupon-row">
      <input id="coupon-input" type="text" placeholder="Si tienes un cupón, ingrésalo aquí">
      <button id="coupon-apply">Aplicar cupón</button>
    </div>
    <div id="coupon-info" class="hint"></div>
    <div class="sum-grid">
      <div>Apertura del grupo</div><div id="t-met-count">—</div><div id="t-met">—</div>
      <div>Inscripciones <span class="hint">— Renovables a los 365 días</span></div><div id="t-subins-count">—</div><div id="t-subins">—</div>
      <div id="coupon-line-label" class="hidden">Cupón</div><div></div><div id="coupon-line-value" class="hidden">—</div>
      <div>Activables del proyecto</div><div id="t-act-count">—</div><div id="t-act">—</div>
    </div>
    <div class="grid" style="grid-template-columns:1fr auto;row-gap:8px;margin-top:12px">
      <div class="grand">Total antes de impuestos</div><div class="grand" id="t-corp">—</div>
      <div id="t-iva-label">IVA (16%)</div><div id="t-iva">—</div>
      <div id="t-conimp-label">Total con impuestos</div><div id="t-conimp">—</div>
    </div>
    <div class="line" style="justify-content:flex-start;gap:10px;margin-top:10px">
      <input id="pay-card" type="checkbox"><label for="pay-card" class="label">Pagar con tarjeta (se agrega 4.5%)</label>
    </div>
  </div>
</div>

<script>
/* ==================  CONFIG REMOTA  ================== */
const ENDPOINT = "https://script.google.com/macros/s/AKfycbwOt1RHYdFe3lXBg1XpKu_aNaDWDJDUjBPmCYdFaitzpBHHY5czhtnaOyR8czuO52l2/exec";

/* ==================  DATOS LOCALES (precios)  ================== */
/* Mantengo los precios/escala en local para no depender del Sheet.
   Puedes moverlos al mismo endpoint cuando quieras. */
const LOCAL = {
  escalas: [1,5,10,25,50,100],
  participantes: { autodidacta:1, yotenseno:1, lohagocontigo:1 }, // ← por default 1 c/u
  precios: {
    autodidacta:{ mxn:[3990,3800,3600,3300,3000,2700], usd:[239,229,219,199,179,159] },
    yotenseno:{ mxn:[6990,6700,6400,5900,5400,4900], usd:[399,389,369,339,309,279] },
    lohagocontigo:{ mxn:[14990,14500,13900,12900,11900,10900], usd:[899,869,839,779,719,659] }
  },
  descuentos:{
    autodidacta:[0,0.03,0.05,0.10,0.15,0.20],
    yotenseno:[0,0.03,0.05,0.10,0.15,0.20],
    lohagocontigo:[0,0.03,0.05,0.10,0.15,0.20]
  },
  // Regla para considerar el proyecto como corporativo
  incompanyMin:{ autodidacta:25, yotenseno:25, lohagocontigo:10 },
  metodologia:{ mxn:29000, usd:1690, descuento:0.15 },
  cupones:{ CORP10:0.10, CORP15:0.15 }
};

/* ==================  UTILIDADES  ================== */
const MODS=[{key:"autodidacta",title:"Autodidacta"},{key:"yotenseno",title:"Yo Te Enseño"},{key:"lohagocontigo",title:"Lo Hago Contigo"}];
let currency="mxn", appliedCoupon=null;

const $ = s => document.querySelector(s);
const nfByCcy = c => new Intl.NumberFormat(c==="usd"?"en-US":"es-MX",{minimumFractionDigits:2,maximumFractionDigits:2});
const money = (n,c) => (c==="usd"?"USD":"MXN")+" $"+nfByCcy(c).format(Number(n||0));

function findIndexFloor(arr,count){
  const c=Number(count); const exact=arr.indexOf(c); if(exact>=0) return exact;
  let best=-1,val=-Infinity; for(let i=0;i<arr.length;i++){ const v=Number(arr[i]); if(v<=c && v>val){ val=v; best=i; } }
  return best;
}
function getUnitPrice(mod,count,ccy){
  const idx=findIndexFloor(LOCAL.escalas,count);
  if(idx<0) return {ok:false,unit:0,discount:0,scale:1};
  const base = LOCAL.precios[mod][ccy][idx] || 0;
  const disc = LOCAL.descuentos[mod][idx] || 0;
  return { ok:true, unit: base*(1-disc), discount:disc, scale: LOCAL.escalas[idx] };
}
function qualifiesCorporate(){
  return MODS.some(({key})=>{
    const min = Number(LOCAL.incompanyMin[key]||0);
    const cnt = Number($("#p-"+key)?.value || 0);
    return min>0 && cnt>=min;
  });
}
function toggleCorporateBlocks(){
  const show = qualifiesCorporate();
  ["gp-card","corp-benefits-detail","activables-card","totales"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.classList.toggle("hidden", !show);
  });
  const hint = document.getElementById("corp-hint");
  if(hint) hint.classList.toggle("hidden", show);
}

/* ==================  BENEFICIOS (desde endpoint)  ================== */
let BENEFICIOS = { inscripcion: [], activacion: [] };


function renderActivables(){
  const wrap = document.getElementById("activables-card");
  const box = document.getElementById("activables-body");
  if(!wrap || !box) return;

  // Si no hay activables, ocultamos el card
  if(!BENEFICIOS.activacion.length){
    wrap.classList.add("hidden");
    box.innerHTML = "";
    return;
  }
  wrap.classList.remove("hidden");

  box.innerHTML = "";
  BENEFICIOS.activacion.forEach(b=>{
    const row = document.createElement("div");
    row.style.display="grid";
    row.style.gridTemplateColumns="auto 1fr auto";
    row.style.alignItems="center";
    row.style.gap="12px";

    const cb = document.createElement("input");
    cb.type="checkbox";
    cb.checked = !!ACTIVABLE_STATE.get(b.nombre)?.checked;
    cb.addEventListener("change", ()=>{ 
      const st = ACTIVABLE_STATE.get(b.nombre) || {qty:1};
      st.checked = cb.checked; ACTIVABLE_STATE.set(b.nombre, st); recalc(true);
    });

    const label = document.createElement("div");
    label.innerHTML = `<div style="font-weight:600">${b.nombre}</div><div class="hint">${b.descripcion||''}</div>`;

    const cost = document.createElement("div");
    const showCost = currency==="usd" ? b.cost_usd : b.cost_mxn;
    cost.textContent = money(showCost, currency);

    row.appendChild(cb); row.appendChild(label); row.appendChild(cost);
    box.appendChild(row);
  });
}


/* ==================  UI: CARDS  ================== */
function buildCards(){
  const container=$("#cards"); container.innerHTML="";
  MODS.forEach(({key,title})=>{
    const card=document.createElement("div"); card.className="card pricing";
    const h=document.createElement("div"); h.className="title"; h.textContent=title; card.appendChild(h);

    const line=document.createElement("div"); line.className="line";
    const lbl=document.createElement("label"); lbl.className="label"; lbl.textContent="Participantes"; lbl.htmlFor="p-"+key;
    const inp=document.createElement("input"); inp.type="number"; inp.min="0"; inp.step="1"; inp.id="p-"+key; inp.value=LOCAL.participantes[key]||0;
    line.appendChild(lbl); line.appendChild(inp); card.appendChild(line);

    const st=document.createElement("div"); st.className="line";
    st.innerHTML='<div>Subtotal <span class="hint">— Anualmente</span></div><div id="st-'+key+'">—</div>'; card.appendChild(st);

    const pp=document.createElement("div"); pp.className="line";
    pp.innerHTML='<div>Precio por persona</div><div id="pp-'+key+'">—</div>'; card.appendChild(pp);

    const bl=document.createElement("div"); bl.className="subtle"; bl.textContent="Incluye:"; card.appendChild(bl);
    const ul=document.createElement("ul"); ul.className="benefits"; ul.id="b-"+key; card.appendChild(ul);

    container.appendChild(card);
    inp.addEventListener("input", ()=>{ recalc(true); renderBenefitsCards(); });
  });
  renderBenefitsCards();
}

/* Pinta los beneficios en cada card con regla de mínimos y leyenda “Mínimo X membresías” */
function renderBenefitsCards(){
  MODS.forEach(({key})=>{
    const ul=$("#b-"+key); if(!ul) return; ul.innerHTML="";
    const cnt = Number($("#p-"+key)?.value || 0);

    BENEFICIOS.inscripcion.forEach(b=>{
      const need = Number(b.min[key] || 0);
      const ok = cnt >= need && need>0 ? true : (need===0); // si mínimo 0, siempre ✓
      const li=document.createElement("li");
      if(ok){
        const icon=document.createElement("span"); icon.className="check"; icon.textContent="✓";
        li.appendChild(icon);
        li.appendChild(document.createTextNode(" "+b.nombre));
      }else{
        li.className="off";
        const icon=document.createElement("span"); icon.textContent="✗";
        li.appendChild(icon);
        const s=document.createElement("s"); s.textContent=" "+b.nombre; li.appendChild(s);
        const pill=document.createElement("span"); pill.className="pill"; pill.textContent=`Mínimo ${need} membresías`;
        li.appendChild(pill);
      }
      ul.appendChild(li);
    });
  });
}

/* ==================  ACTIVABLES A NIVEL PROYECTO  ================== */
const ACTIVABLE_STATE = new Map(); // nombre -> {checked, qty}

function renderActivables(){
  const box = $("#activables-body"); if(!box) return;
  box.innerHTML = "";
  BENEFICIOS.activacion.forEach(b=>{
    const row = document.createElement("div");
    row.style.display="grid"; row.style.gridTemplateColumns="auto 1fr auto"; row.style.alignItems="center"; row.style.gap="12px";

    const cb = document.createElement("input"); cb.type="checkbox";
    cb.checked = !!ACTIVABLE_STATE.get(b.nombre)?.checked;
    cb.addEventListener("change", ()=>{ 
      const st = ACTIVABLE_STATE.get(b.nombre) || {qty:1};
      st.checked = cb.checked; ACTIVABLE_STATE.set(b.nombre, st); recalc(true);
    });

    const label = document.createElement("div");
    label.innerHTML = `<div style="font-weight:600">${b.nombre}</div><div class="hint">${b.descripcion||''}</div>`;

    const cost = document.createElement("div");
    const showCost = currency==="usd" ? b.cost_usd : b.cost_mxn;
    cost.textContent = money(showCost, currency);

    row.appendChild(cb); row.appendChild(label); row.appendChild(cost);
    box.appendChild(row);
  });
}

/* ==================  DETALLE DE BENEFICIOS (texto)  ================== */
function renderCorpBenefitDetails(){
  const box = $("#corp-benefits-detail"); if(!box) return;
  // Sólo visible si es corporativo
  if(!qualifiesCorporate()){ box.classList.add("hidden"); box.innerHTML=""; return; }
  box.classList.remove("hidden");
  box.innerHTML="";
  BENEFICIOS.inscripcion.forEach(b=>{
    const card=document.createElement("div"); card.className="card";
    const h=document.createElement("div"); h.style.fontWeight="700"; h.style.marginBottom="6px"; h.textContent=b.nombre;
    const p=document.createElement("div"); p.textContent=b.descripcion||"—";
    card.appendChild(h); card.appendChild(p); box.appendChild(card);
  });
}

/* ==================  CÁLCULOS TOTALES  ================== */
function recalc(){
  let totalPart=0, subtotalIns=0;

  MODS.forEach(({key})=>{
    const cnt=Number($("#p-"+key).value||0);
    totalPart+=cnt;
    if(cnt>0){
      const pr=getUnitPrice(key,cnt,currency);
      const groupPrice = pr.unit * cnt;     // subtotal por tarjeta: precio-persona * cantidad
      subtotalIns += groupPrice;
      $("#st-"+key).textContent = money(groupPrice,currency);
      $("#pp-"+key).textContent = money(pr.unit,currency);
    }else{
      $("#st-"+key).textContent = money(0,currency);
      $("#pp-"+key).textContent = money(0,currency);
    }
  });

  // apertura metodología si hay al menos una selección
  const hasAny = MODS.some(({key}) => Number($("#p-"+key).value||0) > 0);
  const apertura = hasAny ? LOCAL.metodologia[currency] * (1 - LOCAL.metodologia.descuento) : 0;

  // activables (sólo si corporativo)
  let actCount=0, actTotal=0;
  if(qualifiesCorporate()){
    BENEFICIOS.activacion.forEach(b=>{
      const st = ACTIVABLE_STATE.get(b.nombre);
      if(st?.checked){
        actCount += 1;
        actTotal += currency==="usd" ? Number(b.cost_usd||0) : Number(b.cost_mxn||0);
      }
    });
  } else {
    // si deja de calificar, desmarcamos visualmente
    ACTIVABLE_STATE.clear();
    renderActivables();
  }

  let totalAntes = subtotalIns + apertura + actTotal;

  // cupón
  let discountAmt = 0;
  if(appliedCoupon?.pct>0){
    discountAmt = totalAntes * appliedCoupon.pct;
    totalAntes = Math.max(0, totalAntes - discountAmt);
    $("#coupon-line-label").classList.remove("hidden");
    $("#coupon-line-value").classList.remove("hidden");
    $("#coupon-line-value").textContent = "− " + money(discountAmt, currency);
  }else{
    $("#coupon-line-label").classList.add("hidden");
    $("#coupon-line-value").classList.add("hidden");
  }

  const ivaPct = currency==="mxn" ? 0.16 : 0;
  const iva = totalAntes * ivaPct;
  let totalDespues = totalAntes + iva;
  if($("#pay-card").checked){
    totalDespues += totalDespues * 0.045;
    $("#t-conimp-label").textContent = "Total con impuestos + fee tarjeta (4.5%)";
  }else{
    $("#t-conimp-label").textContent = "Total con impuestos";
  }

  $("#t-met-count").textContent = hasAny ? 1 : 0;
  $("#t-met").textContent = money(apertura,currency);
  $("#t-subins-count").textContent = totalPart;
  $("#t-subins").textContent = money(subtotalIns,currency);
  $("#t-act-count").textContent = actCount;
  $("#t-act").textContent = money(actTotal,currency);
  $("#t-corp").textContent = money(totalAntes,currency);
  $("#t-iva").textContent = money(iva,currency);
  $("#t-conimp").textContent = money(totalDespues,currency);

  // visibilidad de módulos corporativos
  toggleCorporateBlocks();
  // refrescar leyendas de beneficios (por si cambió el conteo)
  renderBenefitsCards();
}

/* ==================  ARRANQUE ================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // fechas
  const now=new Date(); const plus30=new Date(now.getTime()+30*24*60*60*1000);
  const cap = d => d.toLocaleDateString('es-MX',{weekday:'long',day:'numeric',month:'long',year:'numeric'}).replace(/\b(de|del)\b/g,'$&');
  $("#gp-fecha").value = cap(now);
  $("#gp-vigencia").value = cap(plus30);

  // moneda
  const tog=$("#currencyToggle");
  const setCcy = c => { currency=c; tog.classList.toggle("right", currency==="usd"); tog.setAttribute("aria-checked", currency==="usd"?"true":"false"); renderActivables(); recalc(); };
  tog.addEventListener("click", ()=> setCcy(currency==="mxn"?"usd":"mxn"));
  tog.addEventListener("keydown", e => { if(e.key===" "||e.key==="Enter"){ e.preventDefault(); setCcy(currency==="mxn"?"usd":"mxn"); }});

  // cupón
  $("#coupon-apply").addEventListener("click", ()=>{
    const raw = ($("#coupon-input").value||"").trim().toUpperCase();
    const info=$("#coupon-info");
    if(!raw){ appliedCoupon=null; info.textContent=""; recalc(); return; }
    const pct = LOCAL.cupones[raw];
    if(!pct){ appliedCoupon=null; info.textContent="Cupón inválido o expirado."; recalc(); return; }
    appliedCoupon = { code:raw, pct:Number(pct) };
    info.textContent = "✅ Cupón aplicado: " + Math.round(pct*100) + "%";
    recalc();
  });
  $("#pay-card").addEventListener("change", ()=>recalc());

  // construir UI
  buildCards();
  // cargar beneficios desde Apps Script
  loadBeneficios().catch(err=>{
    const b=$("#errorBox"); b.style.display="block";
    b.textContent="No se pudieron cargar los beneficios del servidor. Se mostrarán cuando vuelva a haber conexión.";
  });

  recalc();
});
</script>
</body>
</html>
